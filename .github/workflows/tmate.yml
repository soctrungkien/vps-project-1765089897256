name: Create VPS

on:
  workflow_dispatch:
    inputs:
      crd:
        description: 'Chrome code'
        required: false
        type: string

      delete:
        type: boolean
        default: true

  repository_dispatch:
    types: [create-vps]

env:
  VPS_NAME: ${{ github.event.repository.name }}
  TMATE_SERVER: nyc1.tmate.io
  GITHUB_TOKEN_VPS: ${{ secrets.GITHUB_TOKEN }}
  PASSWORD: ${{ secrets.PASSWORD }}
  NGROK_SERVER_URL: https://vps-github.vercel.app
  CRD: ${{ inputs.crd }}

jobs:
  delete:
    if: ${{ inputs.delete == true }}
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout source
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete folder
        run: |
          if [ -d ".backup" ]; then
            echo "[LOG] Thu muc .backup ton tai, tien hanh xoa"
            rm -rf .backup
            echo "[LOG] Da xoa xong .backup"
          else
            echo "[LOG] Thu muc .backup khong ton tai, bo qua"
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          if git diff --cached --quiet; then
            echo "[LOG] Khong co thay doi nao de commit"
          else
            git commit -m "Delete .backup folder"
            git push
            echo "[LOG] Da commit va push thanh cong"
          fi

  vps:
    runs-on: windows-2025
    permissions:
      contents: write
      actions: write

    steps:
    - name: ‚¨áÔ∏è Checkout source
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: üêç T·∫°o file VPS info + setup
      run: |
        tzutil /s "SE Asia Standard Time"
        powershell -Command "Set-WinHomeLocation -GeoId 251"
        tzutil /g
        Invoke-WebRequest "https://archive.org/download/CDATA/CDATA.zip" -OutFile "D:\CDATA.zip"
        powershell -Command "if (Test-Path 'D:\CDATA.zip') { Write-Output '[LOG] Tai xong, dang giai nen'; Expand-Archive 'D:\CDATA.zip' -DestinationPath C:\ -Force; Write-Output '[LOG] Giai nen xong' } else { Write-Output '[LOG] Khong tim thay CDATA.zip' }"
        reg add "HKCU\Control Panel\Desktop" /v PaintDesktopVersion /t REG_DWORD /d 0 /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "AutoUpdates" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "WinBuild" /t REG_DWORD /d "26100" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "WinLangID" /t REG_DWORD /d "1033" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SettingsVersion" /t REG_DWORD /d "6" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "WelcomeShown" /t REG_DWORD /d "3" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "UpdateCheck" /t REG_BINARY /d "9597b1df2573dc01" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "FrameStyle" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarLargerIcons" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarSpacierIcons" /t REG_DWORD /d "4294967295" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarOneSegment" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarCenterIcons" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "FatTaskbar" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarTranslucentEffect" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTraySpacierIcons" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarControlCenter" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayInputSwitch" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayPower" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayMicrophone" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayLocation" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "RestyleControls" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "AutoUpdates" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "WinBuild" /t REG_DWORD /d "26100" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "WinLangID" /t REG_DWORD /d "1033" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SettingsVersion" /t REG_DWORD /d "6" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "WelcomeShown" /t REG_DWORD /d "3" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "UpdateCheck" /t REG_BINARY /d "9597b1df2573dc01" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "FrameStyle" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarLargerIcons" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarSpacierIcons" /t REG_DWORD /d "4294967295" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarOneSegment" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarCenterIcons" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "FatTaskbar" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarTranslucentEffect" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTraySpacierIcons" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "TaskbarControlCenter" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayInputSwitch" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayPower" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayMicrophone" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "SysTrayLocation" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "RestyleControls" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_LargeMFUIcons" /t REG_DWORD /d "2" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_LargeAllAppsIcons" /t REG_DWORD /d "2" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "AllProgramsFlyout" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "StartMetroAppsFolder" /t REG_DWORD /d "2" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_SortOverride" /t REG_DWORD /d "10" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_NotifyNewApps" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_AutoCascade" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_LargeSearchIcons" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_AskCortana" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "HideUserFrame" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_RightPaneIcons" /t REG_DWORD /d "2" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowUser" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowMyDocs" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowMyPics" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowMyMusic" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowVideos" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowDownloads" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowSkyDrive" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "StartMenuFavorites" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowRecentDocs" /t REG_DWORD /d "2" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowNetPlaces" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowNetConn" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowMyComputer" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowControlPanel" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowPCSettings" /t REG_DWORD /d "1" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_AdminToolsRoot" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowPrinters" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowSetProgramAccessAndDefaults" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowTerminal" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowCommandPrompt" /t REG_DWORD /d "0" /f
        Reg.exe add "HKEY_CURRENT_USER\SOFTWARE\StartIsBack" /v "Start_ShowRun" /t REG_DWORD /d "1" /f
        reg.exe add "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" /f /ve
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v Hidden /t REG_DWORD /d 1 /f
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v ShowSuperHidden /t REG_DWORD /d 1 /f
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v HideFileExt /t REG_DWORD /d 0 /f
        C:\StartBack.exe /SILENT
        taskkill /f /im StartAllBackCfg.exe
        regsvr32 "C:\ProgramData\PhoenixOS\Apps\Acrylic\ExplorerBlurMica.dll"
        C:\AcrylicMenus\AcrylicMenusLoader.exe
        cmd /c "tasklist /fi ""imagename eq explorer.exe"" | find /i ""explorer.exe"" >nul && exit || start explorer.exe"
        label C: GithubVPS
        label D: Data
        mkdir -Force links
        "VPS kh·ªüi t·∫°o - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath "links/${env:VPS_NAME}.txt" -Encoding UTF8

    - name: üÖ∞Ô∏è Shotcut exit
      shell: pwsh
      run: |
        powershell -Command "New-Item -ItemType Directory -Path C:\runner -Force | Out-Null"
        $s = (New-Object -ComObject WScript.Shell).CreateShortcut("$home\Desktop\Exit VPS.lnk"); 
        $s.TargetPath = "cmd.exe"; 
        $s.Arguments = "/c echo `"Hi`" > C:\runner\stop.flag && echo `"VPS se tat sau vai giay (nhieu nhat la 1 phut)`" && pause"
        $s.IconLocation = "shell32.dll,27"; $s.Save()

    - name: üêí Chrome_1
      shell: pwsh
      run: |
        $pass = $env:PASSWORD
        Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi" -TimeoutSec 60
        msiexec /i crd.msi /quiet /norestart | Out-Null

    - name: üêí Chrome_2
      shell: pwsh
      if: ${{ contains(env.CRD, '/') }}
      run: |
        $ErrorActionPreference = "Continue"
        $pass = $env:PASSWORD
        & "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="$env:CRD" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="Github VPS - $env:VPS_NAME - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" --pin=$pass
      continue-on-error: true

    - name: üñ•Ô∏è C√†i ƒë·∫∑t v√† ch·∫°y TightVNC, noVNC, Cloudflared
      shell: pwsh
      run: |
        Write-Host "üì• Installing TightVNC, noVNC, and Cloudflared..."
        
        try {
          Write-Host "üì• Installing TightVNC..."
          Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.85/tightvnc-2.8.85-gpl-setup-64bit.msi" -OutFile "tightvnc-setup.msi" -TimeoutSec 60
          Write-Host "‚úÖ TightVNC downloaded"

          $pass = $env:PASSWORD
          $args = @(
            '/i', 'tightvnc-setup.msi', '/quiet', '/norestart'
            'ADDLOCAL=Server'
            'SERVER_REGISTER_AS_SERVICE=1'
            'SERVER_ADD_FIREWALL_EXCEPTION=1'
            'SET_USEVNCAUTHENTICATION=1'
            'VALUE_OF_USEVNCAUTHENTICATION=1'
            "SET_PASSWORD=1"
            "VALUE_OF_PASSWORD=$pass"
            'SET_ACCEPTHTTPCONNECTIONS=1'
            'VALUE_OF_ACCEPTHTTPCONNECTIONS=1'
          )
          Start-Process msiexec.exe -Wait -ArgumentList $args -NoNewWindow
          Write-Host "‚úÖ TightVNC installed"
          
          Write-Host "üîß Enabling loopback connections in TightVNC registry..."
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AllowLoopback" -Value 1 -ErrorAction SilentlyContinue
          
          Write-Host "üîç Stopping any existing tvnserver processes..."
          Stop-Process -Name "tvnserver" -Force -ErrorAction SilentlyContinue
          Stop-Service -Name "tvnserver" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          Write-Host "üîç Checking for port 5900 conflicts..."
          $portCheck = netstat -aon | FindStr :5900
          if ($portCheck) {
            Write-Host "‚ö†Ô∏è Port 5900 is already in use: $portCheck"
            Stop-Process -Id ($portCheck -split '\s+')[-1] -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 5
          }
          
          Write-Host "üöÄ Starting TightVNC server..."
          Start-Process -FilePath "C:\Program Files\TightVNC\tvnserver.exe" -ArgumentList "-run -localhost no" -WindowStyle Hidden -RedirectStandardOutput "vnc_start.log" -RedirectStandardError "vnc_error.log"
          Start-Sleep -Seconds 40
          Get-Content "vnc_start.log" -ErrorAction SilentlyContinue | Write-Host
          Get-Content "vnc_error.log" -ErrorAction SilentlyContinue | Write-Host
          
          netsh advfirewall firewall add rule name="Allow VNC 5900" dir=in action=allow protocol=TCP localport=5900
          netsh advfirewall firewall add rule name="Allow noVNC 6080" dir=in action=allow protocol=TCP localport=6080
          Write-Host "‚úÖ Firewall rules added"
          
          Write-Host "üì• Installing Python dependencies for noVNC and websockify..."
          Write-Host "üîç Checking Python and pip versions..."
          python --version | Write-Host
          python -m pip --version | Write-Host
          
          $maxPipAttempts = 5
          for ($i = 1; $i -le $maxPipAttempts; $i++) {
            try {
              python -m pip install --upgrade pip --timeout 60 2>&1 | Out-File -FilePath "pip_install.log" -Append -Encoding UTF8
              pip install --force-reinstall numpy novnc websockify==0.13.0 --timeout 60 2>&1 | Out-File -FilePath "pip_install.log" -Append -Encoding UTF8
              Write-Host "‚úÖ Python dependencies installed"
              break
            } catch {
              Write-Host "‚ö†Ô∏è Pip install attempt $i/$maxPipAttempts failed: $_"
              Get-Content "pip_install.log" -ErrorAction SilentlyContinue | Write-Host
              if ($i -eq $maxPipAttempts) {
                Write-Host "‚ùå Failed to install Python dependencies"
                exit 1
              }
              Start-Sleep -Seconds 10
            }
          }
          
          Write-Host "üîç Checking noVNC installation via pip..."
          try {
            $novncInfo = pip show novnc
            Write-Host "üìú noVNC package info:"
            Write-Host $novncInfo
            $novncPath = ($novncInfo | Select-String "Location: (.*)").Matches.Groups[1].Value + "\novnc"
            if (Test-Path "$novncPath") {
              dir $novncPath -Recurse | Write-Host
              if (-not (Test-Path "$novncPath/vnc.html")) {
                Write-Host "‚ùå noVNC directory is incomplete, vnc.html not found"
                Write-Host "üîÑ Falling back to GitHub download..."
                $novncVersion = "v1.7.0-beta"
                $maxDownloadAttempts = 5
                for ($i = 1; $i -le $maxDownloadAttempts; $i++) {
                  try {
                    Write-Host "üì• Downloading noVNC release $novncVersion (attempt $i/$maxDownloadAttempts)..."
                    Remove-Item -Recurse -Force noVNC -ErrorAction SilentlyContinue
                    $novncUrl = "https://github.com/novnc/noVNC/archive/refs/tags/$novncVersion.zip"
                    Write-Host "üîó Using URL: $novncUrl"
                    $response = Invoke-WebRequest -Uri $novncUrl -OutFile "noVNC.zip" -TimeoutSec 60 -PassThru
                    Write-Host "‚ÑπÔ∏è HTTP Status: $($response.StatusCode) $($response.StatusDescription)"
                    Expand-Archive -Path "noVNC.zip" -DestinationPath "." -Force
                    Move-Item -Path "noVNC-$($novncVersion.Substring(1))" -Destination "noVNC" -Force
                    Write-Host "‚úÖ noVNC downloaded and extracted"
                    $novncPath = "noVNC"
                    break
                  } catch {
                    Write-Host "‚ö†Ô∏è noVNC download attempt $i/$maxDownloadAttempts failed: $_"
                    if ($i -eq $maxDownloadAttempts) {
                      Write-Host "‚ùå Failed to download noVNC"
                      exit 1
                    }
                    Start-Sleep -Seconds 10
                  }
                }
              }
            } else {
              Write-Host "‚ùå noVNC directory does not exist, falling back to GitHub download..."
              $novncVersion = "v1.7.0-beta"
              $maxDownloadAttempts = 5
              for ($i = 1; $i -le $maxDownloadAttempts; $i++) {
                try {
                  Write-Host "üì• Downloading noVNC release $novncVersion (attempt $i/$maxDownloadAttempts)..."
                  Remove-Item -Recurse -Force noVNC -ErrorAction SilentlyContinue
                  $novncUrl = "https://github.com/novnc/noVNC/archive/refs/tags/$novncVersion.zip"
                  Write-Host "üîó Using URL: $novncUrl"
                  $response = Invoke-WebRequest -Uri $novncUrl -OutFile "noVNC.zip" -TimeoutSec 60 -PassThru
                  Write-Host "‚ÑπÔ∏è HTTP Status: $($response.StatusCode) $($response.StatusDescription)"
                  Expand-Archive -Path "noVNC.zip" -DestinationPath "." -Force
                  Move-Item -Path "noVNC-$($novncVersion.Substring(1))" -Destination "noVNC" -Force
                  Write-Host "‚úÖ noVNC downloaded and extracted"
                  $novncPath = "noVNC"
                  break
                } catch {
                  Write-Host "‚ö†Ô∏è noVNC download attempt $i/$maxDownloadAttempts failed: $_"
                  if ($i -eq $maxDownloadAttempts) {
                    Write-Host "‚ùå Failed to download noVNC"
                    exit 1
                  }
                  Start-Sleep -Seconds 10
                }
              }
            }
          } catch {
            Write-Host "‚ö†Ô∏è Failed to check noVNC package via pip, falling back to GitHub download..."
            $novncVersion = "v1.7.0-beta"
            $maxDownloadAttempts = 5
            for ($i = 1; $i -le $maxDownloadAttempts; $i++) {
              try {
                Write-Host "üì• Downloading noVNC release $novncVersion (attempt $i/$maxDownloadAttempts)..."
                Remove-Item -Recurse -Force noVNC -ErrorAction SilentlyContinue
                $novncUrl = "https://github.com/novnc/noVNC/archive/refs/tags/$novncVersion.zip"
                Write-Host "üîó Using URL: $novncUrl"
                $response = Invoke-WebRequest -Uri $novncUrl -OutFile "noVNC.zip" -TimeoutSec 60 -PassThru
                Write-Host "‚ÑπÔ∏è HTTP Status: $($response.StatusCode) $($response.StatusDescription)"
                Expand-Archive -Path "noVNC.zip" -DestinationPath "." -Force
                Move-Item -Path "noVNC-$($novncVersion.Substring(1))" -Destination "noVNC" -Force
                Write-Host "‚úÖ noVNC downloaded and extracted"
                $novncPath = "noVNC"
                break
              } catch {
                Write-Host "‚ö†Ô∏è noVNC download attempt $i/$maxDownloadAttempts failed: $_"
                if ($i -eq $maxDownloadAttempts) {
                  Write-Host "‚ùå Failed to download noVNC"
                  exit 1
                }
                Start-Sleep -Seconds 10
              }
            }
          }
          
          Write-Host "üîç Checking noVNC directory structure..."
          if (-not (Test-Path "$novncPath/vnc.html")) {
            Write-Host "‚ùå noVNC directory is incomplete, vnc.html not found"
            exit 1
          }
          
          Write-Host "üîç Checking for port 6080 conflicts..."
          $portCheck = netstat -aon | FindStr :6080
          if ($portCheck) {
            Write-Host "‚ö†Ô∏è Port 6080 is already in use: $portCheck"
            Stop-Process -Id ($portCheck -split '\s+')[-1] -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 5
          }
          
          Write-Host "üöÄ Starting websockify..."
          Start-Process -FilePath "python" -ArgumentList "-m", "websockify", "6080", "127.0.0.1:5900", "--web", "$novncPath", "--verbose" -RedirectStandardOutput "websockify.log" -RedirectStandardError "websockify_error.log" -NoNewWindow -PassThru
          Start-Sleep -Seconds 15
          Get-Content "websockify.log" -ErrorAction SilentlyContinue | Write-Host
          Get-Content "websockify_error.log" -ErrorAction SilentlyContinue | Write-Host
          
          Write-Host "üì• Installing Cloudflared..."
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe" -TimeoutSec 60
          Write-Host "‚úÖ Cloudflared downloaded"
          
          Write-Host "üåê Starting Cloudflared tunnel..."
          Start-Process -FilePath "cloudflared.exe" -ArgumentList "tunnel", "--url", "http://localhost:6080", "--no-autoupdate", "--edge-ip-version", "auto", "--protocol", "http2", "--logfile", "cloudflared.log" -WindowStyle Hidden
          Start-Sleep -Seconds 40
          Get-Content "cloudflared.log" -ErrorAction SilentlyContinue | Write-Host
          
          Write-Host "üöÄ Checking noVNC and retrieving Cloudflared URL..."
          
          Write-Host "üîç Checking for port 5900 and 6080 conflicts..."
          netstat -aon | FindStr :5900 | Write-Host
          netstat -aon | FindStr :6080 | Write-Host
          
          Write-Host "üîç Checking VNC and websockify processes..."
          Get-Process -Name "tvnserver" -ErrorAction SilentlyContinue | Format-Table -Property Name, Id, StartTime
          Get-Process -Name "python" -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like "*websockify*" } | Format-Table -Property Name, Id, StartTime
          
          $vncReady = $false
          for ($i = 1; $i -le 30; $i++) {
            try {
              $tcpConnection = Test-NetConnection -ComputerName "localhost" -Port 5900 -WarningAction SilentlyContinue
              if ($tcpConnection.TcpTestSucceeded) {
                try {
                  $vncTest = New-Object System.Net.Sockets.TcpClient
                  $vncTest.Connect("127.0.0.1", 5900)
                  Write-Host "‚úÖ VNC server accepting connections"
                  $vncTest.Close()
                  $vncReady = $true
                  break
                } catch {
                  Write-Host "‚ùå VNC server not accepting connections: $_"
                  Get-Content "vnc_error.log" -ErrorAction SilentlyContinue | Write-Host
                }
              }
            } catch {
              Write-Host "‚ö†Ô∏è VNC connection test failed: $_"
            }
            Write-Host "‚è≥ Waiting for VNC server... ($i/30)"
            
            if ($i % 10 -eq 0) {
              Write-Host "üîÑ Restarting VNC server..."
              Stop-Process -Name "tvnserver" -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 5
              Start-Process -FilePath "C:\Program Files\TightVNC\tvnserver.exe" -ArgumentList "-run -localhost no" -WindowStyle Hidden -RedirectStandardOutput "vnc_start.log" -RedirectStandardError "vnc_error.log"
              Start-Sleep -Seconds 40
              Get-Content "vnc_start.log" -ErrorAction SilentlyContinue | Write-Host
              Get-Content "vnc_error.log" -ErrorAction SilentlyContinue | Write-Host
            }
            Start-Sleep -Seconds 2
          }
          
          if (-not $vncReady) {
            Write-Host "‚ùå VNC server not ready, exiting..."
            Get-Content "vnc_error.log" -ErrorAction SilentlyContinue | Write-Host
            exit 1
          }
          
          $websockifyReady = $false
          for ($i = 1; $i -le 3; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:6080/vnc.html" -TimeoutSec 5 -UseBasicParsing -ErrorAction Stop
              Write-Host "‚úÖ noVNC web interface accessible"
              $websockifyReady = $true
              break
            } catch {
              Write-Host "‚ö†Ô∏è noVNC check failed (attempt $i/3): $_"
              Get-Content "websockify.log" -ErrorAction SilentlyContinue | Write-Host
              Get-Content "websockify_error.log" -ErrorAction SilentlyContinue | Write-Host
              Stop-Process -Name "python" -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 5
              Start-Process -FilePath "python" -ArgumentList "-m", "websockify", "6080", "127.0.0.1:5900", "--web", "$novncPath", "--verbose" -RedirectStandardOutput "websockify.log" -RedirectStandardError "websockify_error.log" -NoNewWindow -PassThru
              Start-Sleep -Seconds 15
            }
          }
          
          if (-not $websockifyReady) {
            Write-Host "‚ùå Failed to start noVNC, exiting..."
            Get-Content "websockify.log" -ErrorAction SilentlyContinue | Write-Host
            Get-Content "websockify_error.log" -ErrorAction SilentlyContinue | Write-Host
            exit 1
          }
          
          Write-Host "üåê Retrieving Cloudflared URL..."
          $maxAttempts = 180
          $attempt = 0
          $cloudflaredUrl = ""
          
          do {
            $attempt++
            Write-Host "üîÑ Checking Cloudflared URL (attempt $attempt/$maxAttempts)"
            Start-Sleep -Seconds 3
            
            if (Test-Path "cloudflared.log") {
              try {
                $logContent = Get-Content "cloudflared.log" -Raw -ErrorAction SilentlyContinue
                if ($logContent -match 'https://[a-zA-Z0-9-]+\.trycloudflare\.com') {
                  $cloudflaredUrl = $matches[0]
                  Write-Host "‚úÖ Found Cloudflared URL: $cloudflaredUrl"
                  break
                }
              } catch {
                Write-Host "‚ö†Ô∏è Error reading cloudflared.log: $_"
              }
            }
            
            if ($attempt % 20 -eq 0) {
              Write-Host "üîÑ Restarting Cloudflared..."
              Stop-Process -Name "cloudflared" -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 3
              Start-Process -FilePath "cloudflared.exe" -ArgumentList "tunnel", "--url", "http://localhost:6080", "--no-autoupdate", "--edge-ip-version", "auto", "--protocol", "http2", "--logfile", "cloudflared.log" -WindowStyle Hidden
              Start-Sleep -Seconds 40
              Get-Content "cloudflared.log" -ErrorAction SilentlyContinue | Write-Host
            }
          } while ($attempt -lt $maxAttempts)
          
          if ($cloudflaredUrl) {
            $remoteLink = "$cloudflaredUrl/vnc.html"
            Write-Host "üåå Remote VNC URL: $remoteLink"
            
            $remoteLink | Out-File -FilePath "remote-link.txt" -Encoding UTF8 -NoNewline
            
            try {
              git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git config --global user.name "github-actions[bot]"
              git add remote-link.txt
              git commit -m "üîó Updated remote-link.txt - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" --allow-empty
              git push origin main --force-with-lease
              Write-Host "‚úÖ Remote link committed"
            } catch {
              Write-Host "‚ö†Ô∏è Failed to commit remote-link.txt: $_"
            }
            
            try {
              $body = @{ github_token = "Github VPS - $env:VPS_NAME - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"; vnc_link = $remoteLink } | ConvertTo-Json
              Invoke-RestMethod -Uri "https://vps-github.vercel.app/api/vpsuser" -Method Post -Body $body -ContentType "application/json" -TimeoutSec 20
              Write-Host "üì§ Remote VNC URL sent to server"
            } catch {
              Write-Host "‚ö†Ô∏è Failed to send remote VNC URL: $_"
            }
          } else {
            Write-Host "‚ùå Failed to retrieve Cloudflared URL"
            "TUNNEL_FAILED_$(Get-Date -Format 'yyyyMMdd_HHmmss')" | Out-File -FilePath "remote-link.txt" -Encoding UTF8 -NoNewline
            
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
            git add remote-link.txt
            git commit -m "‚ùå Tunnel failed - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" --allow-empty
            git push origin main --force-with-lease
          }
        } catch {
          Write-Host "‚ö†Ô∏è Setup failed: $_"
          Get-Content "vnc_error.log" -ErrorAction SilentlyContinue | Write-Host
          Get-Content "pip_install.log" -ErrorAction SilentlyContinue | Write-Host
          Get-Content "websockify.log" -ErrorAction SilentlyContinue | Write-Host
          Get-Content "websockify_error.log" -ErrorAction SilentlyContinue | Write-Host
          Get-Content "cloudflared.log" -ErrorAction SilentlyContinue | Write-Host
          exit 1
        }
        
        Write-Host "üöÄ VPS Session Started - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host "üåå Access noVNC via remote-link.txt URL"
        
        mkdir -Force ".backup"
        
        $totalMinutes = 330
        $restartCheckpoint = 320
        $healthCheckInterval = 15
        $backupInterval = 100
        
        for ($i = 1; $i -le $totalMinutes; $i++) {
          $currentTime = Get-Date -Format 'HH:mm:ss'
          Write-Host "üü¢ VPS Running - Minute $i/$totalMinutes ($currentTime)"

          if (Test-Path "C:\runner\stop.flag") {
            Write-Host "üõë Stop flag detected, exiting gracefully!"
            exit 0
          }

          if ($i % $backupInterval -eq 0) {
            Write-Host "üíæ Creating safe backup at minute $i..."
          
            $safeDir = ".backup\_safe"
            New-Item -ItemType Directory -Path $safeDir -Force | Out-Null
          
            function Copy-LiveFile {
              param($src, $dst)
            
              try {
                $dir = Split-Path $dst
                if (-not (Test-Path $dir)) {
                  New-Item -ItemType Directory -Path $dir -Force | Out-Null
                }
            
                $in  = [System.IO.File]::Open(
                  $src,
                  [System.IO.FileMode]::Open,
                  [System.IO.FileAccess]::Read,
                  [System.IO.FileShare]::ReadWrite
                )
            
                $out = [System.IO.File]::Open(
                  $dst,
                  [System.IO.FileMode]::Create,
                  [System.IO.FileAccess]::Write,
                  [System.IO.FileShare]::None
                )
            
                $in.CopyTo($out)
                $out.Close()
                $in.Close()
            
                Write-Host "üü¢ Live copied OK:" $src
              } catch {
                Write-Host "‚ö†Ô∏è Skip locked/busy file:" $src
              }
            }
          
            $normalFiles = @("links","remote-link.txt","vnc_start.log","vnc_error.log","pip_install.log")
            $liveFiles   = @("websockify.log","websockify_error.log","cloudflared.log")
          
            foreach ($f in $normalFiles) {
              if (Test-Path $f) {
                Copy-Item $f "$safeDir\$f" -Recurse -Force -ErrorAction SilentlyContinue
              }
            }
          
            foreach ($f in $liveFiles) {
              if (Test-Path $f) {
                Copy-LiveFile $f "$safeDir\$f"
              }
            }
          
            try {
              $backupName = "$($env:VPS_NAME)_$(Get-Date -Format 'yyyyMMdd_HHmm').zip"
              Compress-Archive -Path $safeDir\* -DestinationPath ".backup\$backupName" -Force
              Write-Host "‚úÖ Backup created: $backupName"
          
              git add ".backup\$backupName"
              git commit -m "üíæ Backup - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" --allow-empty
              git push origin main --force-with-lease
            } catch {
              Write-Host "‚ö†Ô∏è Backup zip failed: $_"
            }
          }
          
          if ($i -eq $restartCheckpoint) {
            Write-Host "üîÅ Preparing restart in $($totalMinutes - $i) minutes..."
          }
          
          Start-Sleep -Seconds 60
        }
        
        Write-Host "‚è∞ VPS session completed."
